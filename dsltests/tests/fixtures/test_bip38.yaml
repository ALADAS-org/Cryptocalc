# Test BIP38 Encryption/Decryption
name: "BIP38 Encryption Tests"
description: "Test du chiffrement et déchiffrement BIP38 des clés privées"

imports:
  - CryptoService
  - BIP38Service

tests:
  - name: "Encrypt and decrypt private key with BIP38"
    steps:
      - action: generateEntropy
        params:
          size: 256
        assign: entropy
        
      - action: generateWallet
        params:
          type: HD_WALLET
          entropy: $entropy
          blockchain: BTC
        assign: wallet
        
      - action: encrypt
        params:
          privateKey: $wallet.privateKey
          passphrase: "MyStrongPassword123!"
          difficulty: 16384
        assign: encrypted_key
        
      - action: decrypt
        params:
          encryptedKey: $encrypted_key
          passphrase: "MyStrongPassword123!"
        assign: decrypted_key
        
    assertions:
      - property: $encrypted_key
        isDefined: true
        
      - property: $encrypted_key
        matches: "^6PR"  # Format BIP38
        
      - property: $decrypted_key
        isDefined: true
        
      - property: $decrypted_key
        hasLength: 64

  - name: "Test BIP38 with different difficulty levels"
    steps:
      - action: generateEntropy
        params:
          size: 256
        assign: test_entropy
        
      - action: generateWallet
        params:
          type: SIMPLE_WALLET
          entropy: $test_entropy
          blockchain: BTC
        assign: test_wallet
        
      # Difficulté faible (rapide pour tests)
      - action: encrypt
        params:
          privateKey: $test_wallet.privateKey
          passphrase: "TestPass"
          difficulty: 1024
        assign: encrypted_low
        
      # Difficulté standard
      - action: encrypt
        params:
          privateKey: $test_wallet.privateKey
          passphrase: "TestPass"
          difficulty: 16384
        assign: encrypted_standard
        
    assertions:
      - property: $encrypted_low
        matches: "^6PR"
        
      - property: $encrypted_standard
        matches: "^6PR"
        
      # Les deux chiffrements doivent être différents
      - property: $encrypted_low
        notEquals: $encrypted_standard

  - name: "BIP38 encryption with empty passphrase should fail"
    steps:
      - action: generateEntropy
        params:
          size: 128
        assign: simple_entropy
        
      - action: generateWallet
        params:
          type: SIMPLE_WALLET
          entropy: $simple_entropy
          blockchain: BTC
        assign: simple_wallet
        
      # Note: Dans un vrai test, cette étape devrait lever une exception
      # Pour le mock, on vérifie juste la présence du résultat
      - action: encrypt
        params:
          privateKey: $simple_wallet.privateKey
          passphrase: ""
          difficulty: 16384
        assign: should_fail
        
    assertions:
      # Le mock ne gère pas les erreurs, mais dans la vraie implémentation
      # cette assertion devrait vérifier qu'une exception est levée
      - property: $should_fail
        isDefined: true

  - name: "Complete workflow: Generate, Save with BIP38"
    steps:
      - action: generateEntropy
        params:
          size: 256
        assign: final_entropy
        
      - action: generateWallet
        params:
          type: HD_WALLET
          entropy: $final_entropy
          blockchain: BTC
        assign: final_wallet
        
      - action: encrypt
        params:
          privateKey: $final_wallet.privateKey
          passphrase: "VerySecurePassword456!"
        assign: final_encrypted
        
      - action: save
        target: $final_wallet
        params:
          includeEncrypted: true
          encryptedKey: $final_encrypted
        assign: save_result
        
    assertions:
      - property: $final_encrypted
        matches: "^6PR"
        
      - property: $save_result.success
        isTrue: true
        
      - property: $save_result.path
        isDefined: true
